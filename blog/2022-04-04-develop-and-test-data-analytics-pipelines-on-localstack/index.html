<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=https://localstack.cloud/css/vendor/custom.css><link rel=preload as=font href=https://localstack.cloud/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://localstack.cloud/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://localstack.cloud/main.a19d3c2adfc711fc3f6bc56811847d57b4c43e15f80370c7ace24cc11c9244a415edb5a4549a9159f9d46fa75c6809217d4652faf9db9bf78e3d9b93aaf08eb5.css integrity="sha512-oZ08Kt/HEfw/a8VoEYR9V7TEPhX4A3DHrOJMwRySRKQV7bWkVJqRWfnUb6dcaAkhfUZS+vnbm/eOPZuTqvCOtQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Develop and Test Real-time Data Pipelines with LocalStack - LocalStack</title><meta name=description content="LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."><link rel=canonical href=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://localstack.cloud/images/og-preview-image.png"><meta name=twitter:title content="Develop and Test Real-time Data Pipelines with LocalStack"><meta name=twitter:description content="LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."><meta name=twitter:site content="@_localstack"><meta name=twitter:creator content="@_localstack"><meta property="og:title" content="Develop and Test Real-time Data Pipelines with LocalStack"><meta property="og:description" content="LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/"><meta property="og:image" content="https://localstack.cloud/images/og-preview-image.png"><meta property="article:published_time" content="2022-04-04T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-04T00:00:00+00:00"><meta property="og:site_name" content="LocalStack"><meta property="article:publisher" content="https://www.facebook.com/"><meta property="article:author" content="https://www.facebook.com/"><meta property="og:locale" content="en_US"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"\/blog\/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack\/"},"headline":"Develop and Test Real-time Data Pipelines with LocalStack","image":[],"datePublished":"2022-04-04T00:00:00CET","dateModified":"2022-04-04T00:00:00CET","author":{"@type":"Organization","name":"LocalStack"},"publisher":{"@type":"Organization","name":"LocalStack","logo":{"@type":"ImageObject","url":"\/\/images\/og-preview-image.png"}},"description":"LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/localstack.cloud\/"},{"@type":"ListItem","position":3,"name":"Blog","item":"https:\/\/localstack.cloud\/\/blog\/"},{"@type":"ListItem","position":4,"name":"2022 04 04 Develop and Test Data Analytics Pipelines on Localstack","item":"https:\/\/localstack.cloud\/\/blog\/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://localstack.cloud/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://localstack.cloud/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://localstack.cloud/favicon-16x16.png><link rel=mask-icon href=https://localstack.cloud/safari-pinned-tab.svg color=#6b7cf5><link rel=manifest href=https://localstack.cloud/site.webmanifest><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-101988473-1','auto'),ga('send','pageview')</script></head><body class="blog single"><header class="navbar fixed-top navbar-expand-lg navbar-light pb-sm-0 bg-transparent" id=navbarGrad><div class="container pb-3"><div class="d-flex justify-content-lg-between w-100 flex-wrap flex-lg-nowrap"><label class="menu-icon order-0 d-lg-none" for=menu-btn><span class=navicon></span></label><input class="menu-btn order-0" type=checkbox id=menu-btn>
<a class="navbar-brand order-1 order-md-0" href=https://localstack.cloud/><img src=https://localstack.cloud/images/header-logo-new.svg height=43px alt=Logo style=margin-bottom:-10px></a><div class="flex-grow-1 order-2 d-lg-none"></div><ul class="navbar-nav social-nav order-3 order-lg-4"><li class=nav-item><a class=nav-link target=_blank href=https://twitter.com/_localstack><svg width="25" height="26" viewBox="0 0 25 26" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M25 13.25c0 6.9036-5.5964 12.5-12.5 12.5C5.59644 25.75.0 20.1536.0 13.25.0 6.34644 5.59644.75 12.5.75 19.4036.75 25 6.34644 25 13.25zm-6.56-3.0468C19.0443 10.1315 19.6205 9.97084 20.1562 9.73331 19.7558 10.3325 19.2493 10.8586 18.6651 11.2797 18.6709 11.4076 18.6738 11.5366 18.6738 11.6661c0 3.9487-3.0055 8.5014-8.5012 8.5014C8.48534 20.1675 6.91443 19.6731 5.59285 18.825 5.82615 18.8528 6.06457 18.8669 6.30522 18.8669 7.70545 18.8669 8.9936 18.3894 10.0164 17.5879 8.70861 17.5636 7.6054 16.6997 7.22527 15.5129 7.40754 15.5477 7.59449 15.5662 7.78745 15.5662 8.05952 15.5662 8.32401 15.5299 8.57447 15.4612c-1.36658-.2743-2.39692-1.4817-2.39692-2.9294C6.17755 12.5193 6.17755 12.5066 6.17777 12.4939 6.58041 12.7183 7.04144 12.8526 7.53098 12.868 6.7297 12.3323 6.20183 11.4174 6.20183 10.3811c0-.547520000000001.14751-1.06113.40465-1.50232C8.08024 10.687 10.282 11.8764 12.7651 12.001 12.7139 11.7822 12.6874 11.5542 12.6874 11.32c0-1.64975 1.338-2.98781 2.9878-2.98781.8599.0 1.6364.36276 2.1815.94322C18.5369 9.14149 19.1767 8.89304 19.754 8.55056 19.5305 9.24867 19.057 9.83358 18.44 10.2032z" fill="#fff"/></svg><span class=visually-hidden>Twitter</span></a></li><li class=nav-item><a class=nav-link target=_blank href=https://github.com/localstack><svg width="25" height="26" viewBox="0 0 25 26" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.4984.75C5.59688.75.0 6.4882.0 13.5668c0 5.6616 3.58125 10.4647 8.55 12.161C9.175 25.8459 9.40312 25.4501 9.40312 25.1102 9.40312 24.8054 9.39219 23.9996 9.38594 22.9305 5.90938 23.7044 5.175 21.2119 5.175 21.2119c-.56719-1.4808-1.3875-1.875-1.3875-1.875C2.65156 18.5423 3.87187 18.5582 3.87187 18.5582 5.12656 18.6492 5.78594 19.8795 5.78594 19.8795c1.11562 1.9579 2.92656 1.393 3.63906 1.0643C9.5375 20.1156 9.86094 19.5507 10.2188 19.23 7.44375 18.9061 4.525 17.8066 4.525 12.8966c0-1.3994.4875-2.5436 1.2875-3.44036C5.68281 9.13231 5.25469 7.8286 5.93438 6.06534c0 0 1.05-.34468 3.43749 1.31327C10.3688 7.09457 11.4375 6.95256 12.5016 6.94777 13.5625 6.95415 14.6328 7.09457 15.6312 7.38021c2.386-1.65795 3.4344-1.31328 3.4344-1.31328.6813 1.76487.2531 3.06697.125 3.3909C19.9922 10.3546 20.475 11.4988 20.475 12.8982c0 4.9228-2.9219 6.0063-5.7063 6.3238C15.2172 19.6178 15.6172 20.3997 15.6172 21.5949 15.6172 23.3087 15.6016 24.6906 15.6016 25.1102 15.6016 25.4533 15.8266 25.8522 16.4609 25.7262 21.4219 24.0283 25 19.2268 25 13.5668 25 6.4882 19.4031.75 12.4984.75z" fill="#fff"/></svg><span class=visually-hidden>GitHub</span></a></li><li class="nav-item ms-2"><a class="btn btn-primary btn-tertiary" type=link href=https://app.localstack.cloud><i class="bi bi-person"></i> SIGN UP</a></li></ul><div class="collapse navbar-collapse order-4 order-lg-3 flex-grow-0"><ul class="navbar-nav main-nav me-auto gap-xl-4 d-flex flex-wrap flex-sm-nowrap"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=productsDropdown data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>SOLUTIONS</a><div class=dropdown-menu aria-labelledby=productsDropdown><a class=dropdown-item href=https://localstack.cloud/solutions/cloud-emulation>CLOUD EMULATION</a>
<a class=dropdown-item href=https://localstack.cloud/solutions/team-collaboration>TEAM COLLABORATION</a>
<a class=dropdown-item href=https://localstack.cloud/solutions/enterprise-integration>ENTERPRISE INTEGRATION</a>
<a class=dropdown-item href=https://localstack.cloud/solutions/ecosystem>ECOSYSTEM</a></div></li><li class=nav-item><a class=nav-link style=white-space:nowrap href=https://localstack.cloud/pricing/>PRICING</a></li><li class=nav-item><a class=nav-link style=white-space:nowrap href=https://docs.localstack.cloud>RESOURCES</a></li><li class=nav-item><a class=nav-link style=white-space:nowrap href=https://localstack.cloud/blog/>BLOG</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=productsDropdown data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>COMMUNITY</a><div class=dropdown-menu aria-labelledby=productsDropdown><a class=dropdown-item href=https://localstack.cloud/community/stay-informed>STAY INFORMED</a>
<a class=dropdown-item href=https://localstack.cloud/community/get-involved>GET INVOLVED</a></div></li></ul><div class="break order-6 d-md-none"></div></div></div></div></header><script>var myNav=document.getElementById('navbarGrad');window.onscroll=function(){"use strict";window.scrollY>=100?(myNav.classList.add("navbar-visible"),myNav.classList.remove("bg-transparent")):(myNav.classList.add("bg-transparent"),myNav.classList.remove("navbar-visible"))}</script><section class="section section-sm bg-gradient-dark"><div class="position-absolute w-100 section pb-7 pt-9 pt-sm-7 d-none d-md-block"><div class=container><div class="row justify-content-center align-items-center"><div class=col-2><img class=w-100 style=transform:scale(2);opacity:.65 src=https://localstack.cloud/images/heroes/blog.svg></div><div class=col-2></div><div class=col-2></div><div class=col-2><img class=w-100 style=transform:rotate(35deg)scale(1.4);opacity:.9 src=https://localstack.cloud/images/heroes/blog.svg></div><div class=col-2><img class=w-100 style=transform:rotate(0)scale(1.5);opacity:.75 src=https://localstack.cloud/images/heroes/blog.svg></div></div></div></div><div class="container pb-7 pt-9 pt-sm-7"><div class="row justify-content-center align-items-center text-white"><h1 class="text-center m-0 pt-lg-5">Develop and Test Real-time Data Pipelines with LocalStack</h1></div></div></section><section class="section section-sm mb-6"><div class="container px-lg-8"><div class="row justify-content-center"><div class=col-12><article><div class=blog-header><div class="d-flex align-items-center flex-wrap card-footer-text"><p class=mb-0><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2.5c5.5228.0 10 4.47715 10 10 0 5.5228-4.4772 10-10 10-5.52285.0-10-4.4772-10-10 0-5.52285 4.47715-10 10-10zm0 2c-4.41828.0-8 3.58172-8 8 0 4.4183 3.58172 8 8 8 4.4183.0 8-3.5817 8-8 0-4.41828-3.5817-8-8-8zm0 2c.5128.0.935499999999999.38604.9933.88338L13 7.5v4.5858l1.7071 1.7071C15.0976 14.1834 15.0976 14.8166 14.7071 15.2071 14.3466 15.5676 13.7794 15.5953 13.3871 15.2903L13.2929 15.2071l-2-2c-.1563-.1563-.2555-.359-.2842-.575700000000001L11 12.5v-5C11 6.94772 11.4477 6.5 12 6.5z" fill="#8d8b9f"/></svg>7&nbsp;MIN READ&nbsp;&#8212;&nbsp;
posted April 4, 2022 by <a class="stretched-link position-relative">Sam Watson</a></p><p></div></div><p class=lead>LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack.</p><a href=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack.png target=_blank><figure><img class="img-fluid lazyload blur-up" data-sizes=auto src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_20x0_resize_box_2.png data-srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_500x0_resize_box_2.png 500w" width=1280 height=720><noscript><img class=img-fluid sizes=100vw srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_500x0_resize_box_2.png 500w" src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack.png width=1280 height=720></noscript></figure></a><p>At LocalStack, we rely on AWS Lambda as a key part of our serverless infrastructure toolkit. As with any critical service, we want to extract analytics event data from running Lambda functions and aggregate it in our data warehouse so that we can track user stories and squash bugs. But this presents a challenge: how can we emit detailed analytics data while keeping Lambda code simple and performant? To solve this, we developed a serverless streaming data pipeline using CloudWatch Logs and Kinesis that allows us to decouple analytics from application logic.</p><a href=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline.png target=_blank><figure><img class="img-fluid lazyload blur-up" data-sizes=auto src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_20x0_resize_box_2.png data-srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_500x0_resize_box_2.png 500w" width=720 height=130><noscript><img class=img-fluid sizes=100vw srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_500x0_resize_box_2.png 500w" src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline.png width=720 height=130></noscript></figure></a><p>In this pipeline, a Lambda function writes analytics event data as structured JSON payloads to CloudWatch Logs. From there, we use a <a href=https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Subscriptions.html>subscription filter</a> to extract the events from the function&rsquo;s log group and deliver them directly to a Kinesis stream. Finally, a separate Lambda function consumes events off the stream in batches and delivers them to our <a href=https://tinybird.co>Tinybird</a> data warehouse via their HTTP API.
Tinybird is a managed data platform that helps developers build real-time data solutions with familiar tools like HTTP APIs and SQL on top of fully managed ClickHouse clusters.</p><p>You may notice that the data pipeline is itself serverless! This approach requires very little code to maintain, but comes with the tradeoff of configuring multiple AWS services. Testing interconnected serverless cloud components can be tricky, but luckily we can use LocalStack to run the entire pipeline locally. This allows us to catch configuration issues before they&rsquo;re deployed, shortening feedback loops and accelerating development.</p><h2 id=defining-the-data-pipeline>Defining the Data Pipeline</h2><p>At LocalStack we use AWS <a href=https://aws.amazon.com/cdk/>Cloud Development Kit</a> (CDK) to define our infrastructure as code. We can use the <a href=https://github.com/localstack/aws-cdk-local>cdklocal</a> tool to deploy the same CDK stacks on our development machines under LocalStack as we do in production. This allows us to test our CDK code, and therefore our infrastructure itself, without needing to deploy.
Okay, let&rsquo;s define a CDK stack for our data pipeline! We&rsquo;ll start with a boilerplate class definition:</p><pre><code class=language-python># data_pipeline_stack.py


class DataPipelineStack(Stack):
    def __init__(
        self,
        scope: Construct,
        construct_id: str,
        monitored_log_group_arn: str,
        tinybird_auth_token: str,
        tinybird_url: str,
        **kwargs
    ) -&gt; None:
        super().__init__(scope, construct_id, **kwargs)
</code></pre><p>If you&rsquo;re familiar with CDK there shouldn&rsquo;t be anything surprising here. We declare a <code>DataPipelineStack</code> as a CDK Stack class. We also define a few parameters in the constructor that will be useful to us later: the ARN of the CloudWatch log group associated with the Lambda we want to monitor, plus an auth token and API URL for communicating with our Tinybird data warehouse.
Now let&rsquo;s define the beginning of the pipeline.</p><pre><code class=language-python># data_pipeline_stack.py


kinesis_stream = aws_kinesis.Stream(
    self,
    &quot;data_pipeline_kinesis_stream&quot;,
    shard_count=1,
)

monitored_log_group = aws_logs.LogGroup.from_log_group_arn(
    self, &quot;monitored_log_group&quot;, monitored_log_group_arn
)
monitored_log_group.add_subscription_filter(
    &quot;monitored_log_group_cloudwatch_subscription&quot;,
    destination=aws_logs_destinations.KinesisDestination(kinesis_stream),
    filter_pattern=aws_logs.FilterPattern.all(
        aws_logs.FilterPattern.exists(&quot;$.event_class&quot;),
        aws_logs.FilterPattern.exists(&quot;$.event_type&quot;),
    ),
)

</code></pre><p>First we stand up a Kinesis stream for our event data. Next, we import the log group associated with the Lambda function we&rsquo;re interested in using its ARN. Finally, we declare a subscription filter using these two elements. The subscription filter acts as the &ldquo;glue&rdquo; between CloudWatch and Kinesis. Note the filter pattern: this ensures that only the structured events that we care about will be sent to Kinesis. We don&rsquo;t want every Lambda log message to show up in our data warehouse! Our filter only accepts log lines that meet the following criteria:</p><ul><li>JSON encoded</li><li>Contains an <code>event_class</code> field</li><li>Contains an <code>event_type</code> field</li></ul><p>This filter was chosen based on the particular analytics event format we use at LocalStack.
Finally, let&rsquo;s deploy a &ldquo;loader Lambda&rdquo; function to consume events from Kinesis and load them into Tinybird. You can find the function code <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/lambdas/kinesis_tinybird_loader/kinesis_tinybird_loader.py>here</a></p><pre><code class=language-python># data_pipeline_stack.py


loader_lambda = aws_lambda.Function(
    self,
    &quot;kinesis_tinybird_loader&quot;,
    runtime=aws_lambda.Runtime.PYTHON_3_9,
    handler=&quot;kinesis_tinybird_loader.handler&quot;,
    code=aws_lambda.Code.from_asset(
        path.join(
            path.realpath(path.dirname(__file__)),
            &quot;../..&quot;,
            &quot;kinesis_tinybird_loader_pkg.zip&quot;,
        )
    ),
    timeout=Duration.seconds(7),
    environment={
        &quot;TINYBIRD_AUTH_TOKEN&quot;: tinybird_auth_token,
        &quot;TINYBIRD_URL&quot;: tinybird_url,
    },
)
loader_lambda.add_event_source(
    aws_lambda_event_sources.KinesisEventSource(
        kinesis_stream,
        starting_position=aws_lambda.StartingPosition.LATEST,
        retry_attempts=20,
        batch_size=200,
        max_batching_window=Duration.minutes(2),
    )
)
</code></pre><h2 id=mocking-external-resources>Mocking External Resources</h2><p>We&rsquo;ve defined the data pipeline, but in order to test it end-to-end locally we need to mock two additional components. We need to set up a Lambda function with a log group that we can monitor for events, plus a local endpoint that can imitate the Tinybird API.</p><h3 id=logger-lambda-for-testing>Logger Lambda for Testing</h3><p>Since CloudWatch logging is integrated with Lambda out of the box the code for emitting a structured analytics event as a log message is dead simple:</p><pre><code class=language-python># test_logger.py

import json


def handler(event, context):
    message = event.get('message', None)
    print(json.dumps({&quot;event_class&quot;: &quot;test&quot;, &quot;event_type&quot;: &quot;test&quot;, &quot;message&quot;: message}))
</code></pre><h3 id=mock-tinybird-endpoint>Mock Tinybird Endpoint</h3><p>Tinybird has a convenient and simple HTTP API for ingesting data. For the purposes of testing the data pipeline, we just need a local HTTP endpoint that accepts POST requests from the loader Lambda. We&rsquo;ll use a simple Flask server that records requests with the help of the <a href=https://pypi.org/project/http-server-mock/>http-server-mock</a> library. You can find the code <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/tests/integration/mocks/tinybird_request_recorder.py>here</a>.</p><h2 id=deploying-locally>Deploying Locally</h2><p>With our data pipeline stack defined and external resource mocks in order, it&rsquo;s time to deploy everything locally using <code>cdklocal</code>.</p><h3 id=define-a-local-app>Define a Local App</h3><p>To keep things tidy, we&rsquo;ll create a <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/deployments/cdk/external_test_resources_stack.py>separate stack</a> for the test logger Lambda and deploy it alongside the data pipeline stack under a single CDK app specifically for local testing. This way the data pipeline stack itself stays identical to what we deploy to AWS in production.</p><pre><code class=language-python># local_app.py

def main():
    # configuration variables for connecting to local mock Tinybird server
    port = 5111
    host = os.getenv(&quot;TINYBIRD_MOCK_HOST&quot;) or &quot;host.docker.internal&quot;
    tinybird_mock_path = &quot;tinybird&quot;
    tinybird_mock_url = f&quot;http://{host}:{port}/{tinybird_mock_path}&quot;
    
    app = App()

    external_resources = ExternalTestResourcesStack(
        app,
        &quot;ExternalTestResourcesStack&quot;,
        env=constants.ENV_LOCAL,
    )

    data_pipeline = DataPipelineStack(
        app,
        &quot;DataPipelineStack&quot;,
        env=constants.ENV_LOCAL,
        monitored_log_group_arn=Fn.import_value(&quot;test-logger-log-group-arn&quot;),
        tinybird_auth_token=&quot;dummy value&quot;,
        tinybird_url=tinybird_mock_url,
    )
    data_pipeline.add_dependency(external_resources)

    app.synth()


if __name__ == &quot;__main__&quot;:
    main()
</code></pre><p>Note how the <code>DataPipelineStack</code> uses the log group ARN value imported from the <code>ExternalTestResources</code> stack.</p><h3 id=deploy-locally>Deploy Locally</h3><p>Alright, let&rsquo;s deploy! First, we need to start LocalStack, bootstrap the local CDK environment, and deploy the logger Lambda. Please note that you will need <a href=https://localstack.cloud/pricing/>LocalStack Pro</a> enabled for the log subscription feature to work.</p><pre><code class=language-bash>LOCALSTACK_API_KEY=&quot;your key here&quot; localstack start -d
cdklocal bootstrap --app &quot;python local_app.py&quot;
cdklocal deploy --app &quot;python local_app.py&quot; ExternalTestResourcesStack
</code></pre><p>You should see output similar to the following:</p><pre><code> âœ…  ExternalTestResourcesStack

âœ¨  Deployment time: 6.78s

Outputs:
ExternalTestResourcesStack.testloggerlambdaname = ExternalTestResourcesStack-testlogger39117BFF-c39d4d5a
ExternalTestResourcesStack.testloggerloggrouparn = arn:aws:logs:us-east-2:000000000000:log-group:/aws/lambda/ExternalTestResourcesStack-testlogger39117BFF-c39d4d5a:*
Stack ARN:
arn:aws:cloudformation:us-east-2:000000000000:stack/ExternalTestResourcesStack/b5143830

âœ¨  Total time: 13.53s
</code></pre><p>Before we can deploy the data pipeline itself we have to invoke the logger Lambda. CloudWatch log groups for Lambda functions aren&rsquo;t created until the function is executed for the first time. Unless we do this step first the deployment will fail because CDK won&rsquo;t be able to locate the log group resource.
Another small wrinkle is that CDK creates a name for our logger Lambda funtion with a randomly generated suffix. You can automatically identify the function name and invoke it like so:</p><pre><code class=language-bash>LAMBDA_NAME=$( \
    awslocal cloudformation list-exports \
    --region=us-east-2 \
    --query=&quot;Exports[?Name=='test-logger-lambda-name'].Value&quot; \
    --no-paginate \
    --output text) &amp;&amp; \
awslocal lambda invoke \
    --function-name $LAMBDA_NAME /dev/stdout 2&gt;/dev/null \
    --region us-east-2 \
    --payload '{&quot;message&quot;: &quot;hello world&quot;}'
</code></pre><p>Finally, we can deploy the data pipeline stack ðŸŽ‰:</p><pre><code class=language-bash>cdklocal deploy --app &quot;python local_app.py&quot; DataPipelineStack
</code></pre><h3 id=test-end-to-end>Test End-to-End</h3><p>The entire data pipeline is now up and running on our local development machine. To test it we just need to invoke the logger lambda and observe the event arrive at our mock Tinybird endpoint. Make sure you have the mock Tinybird server running. In a separate shell, invoke the logger lambda as shown above. You should see output similar to this appear in the mock server window:</p><pre><code class=language-bash>{&quot;event_class&quot;: &quot;test&quot;, &quot;event_type&quot;: &quot;test&quot;, &quot;message&quot;: &quot;hello world&quot;}
127.0.0.1 - - [01/Apr/2022 12:30:16] &quot;POST /tinybird HTTP/1.1&quot; 200 -
</code></pre><p>This proves that our data pipeline stack is defined and configured correctly. It&rsquo;s reading event data emitted from the logger Lambda into CloudWatch, streaming it through Kinesis, and finally delivering it to our data warehouse API - all running locally!
With this local deployment pattern established, we can build a robust test suite to validate the correctness of the pipeline. Incorporating cloud infrastructure tests into a CI pipeline ensures that any bugs will be caught prior to deployment. You can view a sample integration test case <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/tests/integration/e2e/test_pipeline.py>here</a>.</p><h2 id=conclusion>Conclusion</h2><p>Serverless infrastructure allows organizations to deploy sophisticated, interconnected cloud services with minimal code. But this strategy requires developers to shift their energy towards configuring connections between serverless components. Developers can leverage LocalStack to validate infrastructure before it hits the cloud, shortening feedback loops and keeping systems robust.</p><p>Thanks for reading. You can find the complete serverless data pipeline deployment example codebase <a href=https://github.com/localstack/serverless-streaming-data-pipeline>here</a>.</p></article></div></div></div></section><section class="section bg-gradient-light"><div class=container><div class="row justify-content-center"><div class="d-flex flex-column gap-4 col-lg-12 text-white"><h2 class="h2 text-center">Stay in the loop</h2><p>We'd love to get in touch with you.
Please subscribe with your email to stay tuned for release notes and product updates.
We promise never to send an excessive amount of emails (we hate spam, too).</p><form class="center text-center validate" action=https://sendy.localstack.cloud/subscribe method=post accept-charset=utf-8><div class="input-group d-flex align-items-center gap-3"><input type=email class="form-control email" name=email id=email placeholder=email-address aria-label=email-address aria-describedby=basic-addon2></input>
<input type=hidden name=list value=bZ8926jt167PVq0OXTjaMgag>
<input type=hidden name=subform value=yes><div class=input-group-append><button class="btn btn-primary btn-tertiary form-button" type=submit name=submit>SUBSCRIBE</button></div></div></form></div></div></div></section><footer class="footer pt-6 bg-gradient-dark"><div class="footer-main pb-5"><div class=container><div class="row justify-content-between"><div class="col-12 col-lg-4"><img style=width:243px src=https://localstack.cloud/images/header-logo-new.svg alt="LocalStack Logo"></div><div class="col-12 col-lg-8 mt-4 mt-lg-0"><div class="row gap-4"><div class=col><ul class="list-unstyled gap-4 d-flex flex-column"><li><a class=footer-text href=https://localstack.cloud/contact>Contact</a></li><li><a class=footer-text href=https://localstack.cloud/pricing>Pricing</a></li><li><a class=footer-text href=https://localstack.cloud/blog>Blog</a></li><li><a class=footer-text href=https://localstack.cloud/jobs>Jobs</a></li></ul></div><div class=col><ul class="list-unstyled gap-4 d-flex flex-column"><li><a class=footer-text href=https://app.localstack.cloud>App</a></li><li><a class=footer-text href=https://localstack.cloud/community>Community</a></li><li><a class=footer-text href=https://localstack.cloud/faq>FAQ</a></li></ul></div><div class=col><ul class="list-unstyled gap-4 d-flex flex-column"><li><a class=footer-text href=https://github.com/localstack>GitHub</a></li><li><a class=footer-text href=https://hub.docker.com/u/localstack>DockerHub</a></li><li><a class=footer-text href=https://docs.localstack.cloud>Docs</a></li></ul></div><div class=col><ul class="list-unstyled gap-4 d-flex flex-column"><li class=footer-text>Follow us</li><li class="d-flex gap-3"><a class=footer-text href=https://twitter.com/_localstack><span><svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M25 13.25c0 6.9036-5.5964 12.5-12.5 12.5C5.59644 25.75.0 20.1536.0 13.25.0 6.34644 5.59644.75 12.5.75 19.4036.75 25 6.34644 25 13.25zm-6.56-3.0468C19.0443 10.1315 19.6205 9.97084 20.1562 9.73331 19.7558 10.3325 19.2493 10.8586 18.6651 11.2797 18.6709 11.4076 18.6738 11.5366 18.6738 11.6661c0 3.9487-3.0055 8.5014-8.5012 8.5014C8.48534 20.1675 6.91443 19.6731 5.59285 18.825 5.82615 18.8528 6.06457 18.8669 6.30522 18.8669 7.70545 18.8669 8.9936 18.3894 10.0164 17.5879 8.70861 17.5636 7.6054 16.6997 7.22527 15.5129 7.40754 15.5477 7.59449 15.5662 7.78745 15.5662 8.05952 15.5662 8.32401 15.5299 8.57447 15.4612c-1.36658-.2743-2.39692-1.4817-2.39692-2.9294C6.17755 12.5193 6.17755 12.5066 6.17777 12.4939 6.58041 12.7183 7.04144 12.8526 7.53098 12.868 6.7297 12.3323 6.20183 11.4174 6.20183 10.3811c0-.547520000000001.14751-1.06113.40465-1.50232C8.08024 10.687 10.282 11.8764 12.7651 12.001 12.7139 11.7822 12.6874 11.5542 12.6874 11.32c0-1.64975 1.338-2.98781 2.9878-2.98781.8599.0 1.6364.36276 2.1815.94322C18.5369 9.14149 19.1767 8.89304 19.754 8.55056 19.5305 9.24867 19.057 9.83358 18.44 10.2032z" fill="#fff"/></svg></span></a><a class=footer-text href=https://www.linkedin.com/company/localstack-cloud><span><svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13 26c7.1797.0 13-5.8203 13-13S20.1797.0 13 0 0 5.8203.0 13 5.8203 26 13 26zM9.35126 10.5024C9.97963 10.5024 10.489 9.993 10.489 9.36463S9.97963 8.22687 9.35126 8.22687 8.2135 8.73626 8.2135 9.36463s.50939 1.13777 1.13776 1.13777zm2.21194.8622v6.3122h1.9599V14.5553C13.5231 13.7316 13.6781 12.9339 14.6993 12.9339c1.0073.0 1.0198.941700000000001 1.0198 1.6734v3.0701H17.68V14.2157C17.68 12.5153 17.3139 11.2086 15.3265 11.2086c-.9542.0-1.5938.5236-1.8554 1.0192H13.4446V11.3646H11.5632zm-3.19382.0H10.3324v6.3122H8.36938V11.3646z" fill="#fff"/></svg></span></a></li></ul></div></div></div></div></div></div><div class=footer-bottom><div class="container mb-2"><hr><div class="row pt-4"><div class=col style=color:#fff;opacity:.5>Copyright &copy; LocalStack</div><div class="col text-end"><ul class=list-inline><li class=list-inline-item><a class=footer-last-text href=https://localstack.cloud/privacy-policy>Privacy policy</a></li><li class=list-inline-item><a class=footer-last-text href=https://localstack.cloud/terms>Terms of Service</a></li><li class=list-inline-item><a class=footer-last-text href=https://localstack.cloud/#>Imprint</a></li></ul></div></div></div></div></footer><script src=https://localstack.cloud/js/bootstrap.min.51b4083a09e54138d5bbe9c42a5f5f71af6e60a417f276d5620cbde3b15eb1a07c9ea17a889bc58074adf9b19641039a77521d3131f039300d2fe29ffa532aa8.js integrity="sha512-UbQIOgnlQTjVu+nEKl9fca9uYKQX8nbVYgy947FesaB8nqF6iJvFgHSt+bGWQQOad1IdMTHwOTANL+Kf+lMqqA==" crossorigin=anonymous defer></script><script src=https://localstack.cloud/js/highlight.min.8cdbefd08ec63ef25f4b2510ae50c13b3d9ed43e25a15ddb55f14c33130e68cf8be3131ccf2d087c49f5f21fe88c2f0e2715a21f936047d0d0b85dc48cb864b9.js integrity="sha512-jNvv0I7GPvJfSyUQrlDBOz2e1D4loV3bVfFMMxMOaM+L4xMczy0IfEn18h/ojC8OJxWiH5NgR9DQuF3EjLhkuQ==" crossorigin=anonymous defer></script><script src=https://localstack.cloud/main.min.c667076fdc4df64bfcdde045586335c6f39e83b2890638c198f84cf7b06629acef2ef8536a38a1c5978689f003b2bd3918bc5b3400e1e62670dd1a558e29ccd9.js integrity="sha512-xmcHb9xN9kv83eBFWGM1xvOeg7KJBjjBmPhM97BmKazvLvhTajihxZeGifADsr05GLxbNADh5iZw3RpVjinM2Q==" crossorigin=anonymous defer></script><script src=https://localstack.cloud/index.min.0a6a905e1726be034e7cc659908cb2de137453feff3d8df0900e3714d8c1e63708f0494c044872d7579637d10a418a5472f7dea41016b19d81eb216a4e59e1ae.js integrity="sha512-CmqQXhcmvgNOfMZZkIyy3hN0U/7/PY3wkA43FNjB5jcI8ElMBEhy11eWN9EKQYpUcvfepBAWsZ2B6yFqTlnhrg==" crossorigin=anonymous defer></script></body></html>