<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=https://localstack.cloud/css/vendor/custom.css><link rel=preload as=font href=https://localstack.cloud/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://localstack.cloud/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://localstack.cloud/main.c7b57f6e2b35d304294e9066c55de6b6dba2eae9304428c94b88fc57a260eb3b2a83d37751219d4d7d31848ca612c7fc0e6e0b214bd572c2dae51542903c6166.css integrity="sha512-x7V/bis10wQpTpBmxV3mttui6ukwRCjJS4j8V6Jg6zsqg9N3USGdTX0xhIymEsf8Dm4LIUvVcsLa5RVCkDxhZg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Develop and Test Real-time Data Pipelines with LocalStack - LocalStack</title><meta name=description content="LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."><link rel=canonical href=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://localstack.cloud/images/localstack.png"><meta name=twitter:title content="Develop and Test Real-time Data Pipelines with LocalStack"><meta name=twitter:description content="LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."><meta name=twitter:site content="@_localstack"><meta name=twitter:creator content="@_localstack"><meta property="og:title" content="Develop and Test Real-time Data Pipelines with LocalStack"><meta property="og:description" content="LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/"><meta property="og:image" content="https://localstack.cloud/images/localstack.png"><meta property="article:published_time" content="2022-04-04T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-04T00:00:00+00:00"><meta property="og:site_name" content="LocalStack"><meta property="article:publisher" content="https://www.facebook.com/"><meta property="article:author" content="https://www.facebook.com/"><meta property="og:locale" content="en_US"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"\/blog\/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack\/"},"headline":"Develop and Test Real-time Data Pipelines with LocalStack","image":[],"datePublished":"2022-04-04T00:00:00CET","dateModified":"2022-04-04T00:00:00CET","author":{"@type":"Organization","name":"LocalStack"},"publisher":{"@type":"Organization","name":"LocalStack","logo":{"@type":"ImageObject","url":"\/\/images\/localstack.png"}},"description":"LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack."}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/localstack.cloud\/"},{"@type":"ListItem","position":3,"name":"Blog","item":"https:\/\/localstack.cloud\/\/blog\/"},{"@type":"ListItem","position":4,"name":"2022 04 04 Develop and Test Data Analytics Pipelines on Localstack","item":"https:\/\/localstack.cloud\/\/blog\/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://localstack.cloud/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://localstack.cloud/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://localstack.cloud/favicon-16x16.png><link rel=manifest href=https://localstack.cloud/site.webmanifest><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-101988473-1','auto'),ga('send','pageview')</script></head><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://localstack.cloud/><img src=https://localstack.cloud/images/header-logo.svg height=30px alt=Logo></a><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link target=_blank href=https://twitter.com/_localstack><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><span class="ms-2 visually-hidden">Twitter</span></a></li><li class=nav-item><a class=nav-link target=_blank href=https://github.com/localstack><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li><li class=nav-item><a class="btn btn-primary" type=link href=https://app.localstack.cloud><i class="bi bi-laptop"></i> Sign up</a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=productsDropdown data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Products</a><div class=dropdown-menu aria-labelledby=productsDropdown><a class=dropdown-item href=https://localstack.cloud/products/emulation/>LocalStack Core Emulation</a>
<a class=dropdown-item href=https://localstack.cloud/products/enterprise/>LocalStack Team/Enterprise</a>
<a class=dropdown-item href=https://app.localstack.cloud>LocalStack Web App</a>
<a class=dropdown-item href=https://localstack.cloud/products/cockpit>LocalStack Cockpit</a></div></li><li class=nav-item><a class=nav-link style=white-space:nowrap href=https://localstack.cloud/pricing/>Pricing</a></li><li class=nav-item><a class=nav-link style=white-space:nowrap href=https://localstack.cloud/docs/>Docs</a></li><li class="nav-item active"><a class=nav-link style=white-space:nowrap href=https://localstack.cloud/blog/>Blog</a></li><li class=nav-item><a class=nav-link style=white-space:nowrap href=https://app.localstack.cloud><i class="bi bi-laptop"></i> App</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Develop and Test Real-time Data Pipelines with LocalStack</h1><p><small>Posted April 4, 2022 by <a class="stretched-link position-relative" href=https://localstack.cloud/contributors/sam-watson/>Sam Watson</a>&nbsp;&dash;&nbsp;<strong>7&nbsp;min read</strong></small><p></div><p class=lead>LocalStack makes it easy to develop and test real-time data pipelines that are built with AWS services. Learn how to deploy CloudWatch, Kinesis, Lambda, and external services using CDK on LocalStack.</p><div class="mt-4 mb-4 text-center"><i class="bi bi-stack"></i></div><a href=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack.png target=_blank><figure><img class="img-fluid lazyload blur-up" data-sizes=auto src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_20x0_resize_box_2.png data-srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_500x0_resize_box_2.png 500w" width=1280 height=720><noscript><img class=img-fluid sizes=100vw srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack_hua6a2b158b262e16c120264bfd45634f0_265496_500x0_resize_box_2.png 500w" src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/develop-test-data-pipelines-localstack.png width=1280 height=720></noscript></figure></a><p>At LocalStack, we rely on AWS Lambda as a key part of our serverless infrastructure toolkit. As with any critical service, we want to extract analytics event data from running Lambda functions and aggregate it in our data warehouse so that we can track user stories and squash bugs. But this presents a challenge: how can we emit detailed analytics data while keeping Lambda code simple and performant? To solve this, we developed a serverless streaming data pipeline using CloudWatch Logs and Kinesis that allows us to decouple analytics from application logic.</p><a href=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline.png target=_blank><figure><img class="img-fluid lazyload blur-up" data-sizes=auto src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_20x0_resize_box_2.png data-srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_500x0_resize_box_2.png 500w" width=720 height=130><noscript><img class=img-fluid sizes=100vw srcset="https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_900x0_resize_box_2.png 900w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_800x0_resize_box_2.png 800w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_700x0_resize_box_2.png 700w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_600x0_resize_box_2.png 600w,https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline_hua29b501a2df9f1f42d61375fe85db27d_25520_500x0_resize_box_2.png 500w" src=https://localstack.cloud/blog/2022-04-04-develop-and-test-data-analytics-pipelines-on-localstack/pipeline.png width=720 height=130></noscript></figure></a><p>In this pipeline, a Lambda function writes analytics event data as structured JSON payloads to CloudWatch Logs. From there, we use a <a href=https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Subscriptions.html>subscription filter</a> to extract the events from the function&rsquo;s log group and deliver them directly to a Kinesis stream. Finally, a separate Lambda function consumes events off the stream in batches and delivers them to our <a href=https://tinybird.co>Tinybird</a> data warehouse via their HTTP API.
Tinybird is a managed data platform that helps developers build real-time data solutions with familiar tools like HTTP APIs and SQL on top of fully managed ClickHouse clusters.</p><p>You may notice that the data pipeline is itself serverless! This approach requires very little code to maintain, but comes with the tradeoff of configuring multiple AWS services. Testing interconnected serverless cloud components can be tricky, but luckily we can use LocalStack to run the entire pipeline locally. This allows us to catch configuration issues before they&rsquo;re deployed, shortening feedback loops and accelerating development.</p><h2 id=defining-the-data-pipeline>Defining the Data Pipeline</h2><p>At LocalStack we use AWS <a href=https://aws.amazon.com/cdk/>Cloud Development Kit</a> (CDK) to define our infrastructure as code. We can use the <a href=https://github.com/localstack/aws-cdk-local>cdklocal</a> tool to deploy the same CDK stacks on our development machines under LocalStack as we do in production. This allows us to test our CDK code, and therefore our infrastructure itself, without needing to deploy.
Okay, let&rsquo;s define a CDK stack for our data pipeline! We&rsquo;ll start with a boilerplate class definition:</p><pre><code class=language-python># data_pipeline_stack.py


class DataPipelineStack(Stack):
    def __init__(
        self,
        scope: Construct,
        construct_id: str,
        monitored_log_group_arn: str,
        tinybird_auth_token: str,
        tinybird_url: str,
        **kwargs
    ) -&gt; None:
        super().__init__(scope, construct_id, **kwargs)
</code></pre><p>If you&rsquo;re familiar with CDK there shouldn&rsquo;t be anything surprising here. We declare a <code>DataPipelineStack</code> as a CDK Stack class. We also define a few parameters in the constructor that will be useful to us later: the ARN of the CloudWatch log group associated with the Lambda we want to monitor, plus an auth token and API URL for communicating with our Tinybird data warehouse.
Now let&rsquo;s define the beginning of the pipeline.</p><pre><code class=language-python># data_pipeline_stack.py


kinesis_stream = aws_kinesis.Stream(
    self,
    &quot;data_pipeline_kinesis_stream&quot;,
    shard_count=1,
)

monitored_log_group = aws_logs.LogGroup.from_log_group_arn(
    self, &quot;monitored_log_group&quot;, monitored_log_group_arn
)
monitored_log_group.add_subscription_filter(
    &quot;monitored_log_group_cloudwatch_subscription&quot;,
    destination=aws_logs_destinations.KinesisDestination(kinesis_stream),
    filter_pattern=aws_logs.FilterPattern.all(
        aws_logs.FilterPattern.exists(&quot;$.event_class&quot;),
        aws_logs.FilterPattern.exists(&quot;$.event_type&quot;),
    ),
)

</code></pre><p>First we stand up a Kinesis stream for our event data. Next, we import the log group associated with the Lambda function we&rsquo;re interested in using its ARN. Finally, we declare a subscription filter using these two elements. The subscription filter acts as the &ldquo;glue&rdquo; between CloudWatch and Kinesis. Note the filter pattern: this ensures that only the structured events that we care about will be sent to Kinesis. We don&rsquo;t want every Lambda log message to show up in our data warehouse! Our filter only accepts log lines that meet the following criteria:</p><ul><li>JSON encoded</li><li>Contains an <code>event_class</code> field</li><li>Contains an <code>event_type</code> field</li></ul><p>This filter was chosen based on the particular analytics event format we use at LocalStack.
Finally, let&rsquo;s deploy a &ldquo;loader Lambda&rdquo; function to consume events from Kinesis and load them into Tinybird. You can find the function code <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/lambdas/kinesis_tinybird_loader/kinesis_tinybird_loader.py>here</a></p><pre><code class=language-python># data_pipeline_stack.py


loader_lambda = aws_lambda.Function(
    self,
    &quot;kinesis_tinybird_loader&quot;,
    runtime=aws_lambda.Runtime.PYTHON_3_9,
    handler=&quot;kinesis_tinybird_loader.handler&quot;,
    code=aws_lambda.Code.from_asset(
        path.join(
            path.realpath(path.dirname(__file__)),
            &quot;../..&quot;,
            &quot;kinesis_tinybird_loader_pkg.zip&quot;,
        )
    ),
    timeout=Duration.seconds(7),
    environment={
        &quot;TINYBIRD_AUTH_TOKEN&quot;: tinybird_auth_token,
        &quot;TINYBIRD_URL&quot;: tinybird_url,
    },
)
loader_lambda.add_event_source(
    aws_lambda_event_sources.KinesisEventSource(
        kinesis_stream,
        starting_position=aws_lambda.StartingPosition.LATEST,
        retry_attempts=20,
        batch_size=200,
        max_batching_window=Duration.minutes(2),
    )
)
</code></pre><h2 id=mocking-external-resources>Mocking External Resources</h2><p>We&rsquo;ve defined the data pipeline, but in order to test it end-to-end locally we need to mock two additional components. We need to set up a Lambda function with a log group that we can monitor for events, plus a local endpoint that can imitate the Tinybird API.</p><h3 id=logger-lambda-for-testing>Logger Lambda for Testing</h3><p>Since CloudWatch logging is integrated with Lambda out of the box the code for emitting a structured analytics event as a log message is dead simple:</p><pre><code class=language-python># test_logger.py

import json


def handler(event, context):
    message = event.get('message', None)
    print(json.dumps({&quot;event_class&quot;: &quot;test&quot;, &quot;event_type&quot;: &quot;test&quot;, &quot;message&quot;: message}))
</code></pre><h3 id=mock-tinybird-endpoint>Mock Tinybird Endpoint</h3><p>Tinybird has a convenient and simple HTTP API for ingesting data. For the purposes of testing the data pipeline, we just need a local HTTP endpoint that accepts POST requests from the loader Lambda. We&rsquo;ll use a simple Flask server that records requests with the help of the <a href=https://pypi.org/project/http-server-mock/>http-server-mock</a> library. You can find the code <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/tests/integration/mocks/tinybird_request_recorder.py>here</a>.</p><h2 id=deploying-locally>Deploying Locally</h2><p>With our data pipeline stack defined and external resource mocks in order, it&rsquo;s time to deploy everything locally using <code>cdklocal</code>.</p><h3 id=define-a-local-app>Define a Local App</h3><p>To keep things tidy, we&rsquo;ll create a <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/deployments/cdk/external_test_resources_stack.py>separate stack</a> for the test logger Lambda and deploy it alongside the data pipeline stack under a single CDK app specifically for local testing. This way the data pipeline stack itself stays identical to what we deploy to AWS in production.</p><pre><code class=language-python># local_app.py

def main():
    # configuration variables for connecting to local mock Tinybird server
    port = 5111
    host = os.getenv(&quot;TINYBIRD_MOCK_HOST&quot;) or &quot;host.docker.internal&quot;
    tinybird_mock_path = &quot;tinybird&quot;
    tinybird_mock_url = f&quot;http://{host}:{port}/{tinybird_mock_path}&quot;
    
    app = App()

    external_resources = ExternalTestResourcesStack(
        app,
        &quot;ExternalTestResourcesStack&quot;,
        env=constants.ENV_LOCAL,
    )

    data_pipeline = DataPipelineStack(
        app,
        &quot;DataPipelineStack&quot;,
        env=constants.ENV_LOCAL,
        monitored_log_group_arn=Fn.import_value(&quot;test-logger-log-group-arn&quot;),
        tinybird_auth_token=&quot;dummy value&quot;,
        tinybird_url=tinybird_mock_url,
    )
    data_pipeline.add_dependency(external_resources)

    app.synth()


if __name__ == &quot;__main__&quot;:
    main()
</code></pre><p>Note how the <code>DataPipelineStack</code> uses the log group ARN value imported from the <code>ExternalTestResources</code> stack.</p><h3 id=deploy-locally>Deploy Locally</h3><p>Alright, let&rsquo;s deploy! First, we need to start LocalStack, bootstrap the local CDK environment, and deploy the logger Lambda. Please note that you will need <a href=https://localstack.cloud/pricing/>LocalStack Pro</a> enabled for the log subscription feature to work.</p><pre><code class=language-bash>LOCALSTACK_API_KEY=&quot;your key here&quot; localstack start -d
cdklocal bootstrap --app &quot;python local_app.py&quot;
cdklocal deploy --app &quot;python local_app.py&quot; ExternalTestResourcesStack
</code></pre><p>You should see output similar to the following:</p><pre><code> âœ…  ExternalTestResourcesStack

âœ¨  Deployment time: 6.78s

Outputs:
ExternalTestResourcesStack.testloggerlambdaname = ExternalTestResourcesStack-testlogger39117BFF-c39d4d5a
ExternalTestResourcesStack.testloggerloggrouparn = arn:aws:logs:us-east-2:000000000000:log-group:/aws/lambda/ExternalTestResourcesStack-testlogger39117BFF-c39d4d5a:*
Stack ARN:
arn:aws:cloudformation:us-east-2:000000000000:stack/ExternalTestResourcesStack/b5143830

âœ¨  Total time: 13.53s
</code></pre><p>Before we can deploy the data pipeline itself we have to invoke the logger Lambda. CloudWatch log groups for Lambda functions aren&rsquo;t created until the function is executed for the first time. Unless we do this step first the deployment will fail because CDK won&rsquo;t be able to locate the log group resource.
Another small wrinkle is that CDK creates a name for our logger Lambda funtion with a randomly generated suffix. You can automatically identify the function name and invoke it like so:</p><pre><code class=language-bash>LAMBDA_NAME=$( \
    awslocal cloudformation list-exports \
    --region=us-east-2 \
    --query=&quot;Exports[?Name=='test-logger-lambda-name'].Value&quot; \
    --no-paginate \
    --output text) &amp;&amp; \
awslocal lambda invoke \
    --function-name $LAMBDA_NAME /dev/stdout 2&gt;/dev/null \
    --region us-east-2 \
    --payload '{&quot;message&quot;: &quot;hello world&quot;}'
</code></pre><p>Finally, we can deploy the data pipeline stack ðŸŽ‰:</p><pre><code class=language-bash>cdklocal deploy --app &quot;python local_app.py&quot; DataPipelineStack
</code></pre><h3 id=test-end-to-end>Test End-to-End</h3><p>The entire data pipeline is now up and running on our local development machine. To test it we just need to invoke the logger lambda and observe the event arrive at our mock Tinybird endpoint. Make sure you have the mock Tinybird server running. In a separate shell, invoke the logger lambda as shown above. You should see output similar to this appear in the mock server window:</p><pre><code class=language-bash>{&quot;event_class&quot;: &quot;test&quot;, &quot;event_type&quot;: &quot;test&quot;, &quot;message&quot;: &quot;hello world&quot;}
127.0.0.1 - - [01/Apr/2022 12:30:16] &quot;POST /tinybird HTTP/1.1&quot; 200 -
</code></pre><p>This proves that our data pipeline stack is defined and configured correctly. It&rsquo;s reading event data emitted from the logger Lambda into CloudWatch, streaming it through Kinesis, and finally delivering it to our data warehouse API - all running locally!
With this local deployment pattern established, we can build a robust test suite to validate the correctness of the pipeline. Incorporating cloud infrastructure tests into a CI pipeline ensures that any bugs will be caught prior to deployment. You can view a sample integration test case <a href=https://github.com/localstack/serverless-streaming-data-pipeline/blob/main/tests/integration/e2e/test_pipeline.py>here</a>.</p><h2 id=conclusion>Conclusion</h2><p>Serverless infrastructure allows organizations to deploy sophisticated, interconnected cloud services with minimal code. But this strategy requires developers to shift their energy towards configuring connections between serverless components. Developers can leverage LocalStack to validate infrastructure before it hits the cloud, shortening feedback loops and keeping systems robust.</p><p>Thanks for reading. You can find the complete serverless data pipeline deployment example codebase <a href=https://github.com/localstack/serverless-streaming-data-pipeline>here</a>.</p></article></div></div></div></div><section class="section section-md text-center mt-0 pt-0"><i class="bi bi-stack"></i></section><footer class="footer text-muted"><div class=footer-main><div class=container-fluid><div class=row><div class="col-12 col-sm-12 col-md-4 col-lg-3"><div><img class=footer-logo src=https://localstack.cloud/images/localstack.svg></div></div><div class="col-12 col-sm-12 col-md-6 col-lg-9 mt-4 mt-md-0"><div class=row><div class=col><h5 class="mt-0 h6">LocalStack <i class="bi bi-stack"></i></h5><ul class=list-unstyled><li><a href=https://localstack.cloud/contact>Contact</a></li><li><a href=https://localstack.cloud/pricing>Pricing</a></li><li><a href=https://localstack.cloud/blog>Blog</a></li><li><a href=https://localstack.cloud/jobs>Jobs</a></li><li><a href=https://app.localstack.cloud>App</a></li><li><a href=https://localstack.cloud/community>Community</a></li><li><a href=https://localstack.cloud/faq>FAQ</a></li></ul></div><div class=col><h5 class="mt-0 h6">Resources</h5><ul class=list-unstyled><li><a href=https://github.com/localstack>GitHub</a></li><li><a href=https://hub.docker.com/u/localstack>DockerHub</a></li><li><a href=https://localstack.cloud/docs>Docs</a></li></ul></div></div></div></div></div></div><div class=footer-bottom><div class="container-fluid mb-2"><hr><div class=row><div class=col>Copyright &copy; LocalStack</div><div class="col text-end"><ul class=list-inline><li class=list-inline-item><a href=https://localstack.cloud/privacy-policy>Privacy policy</a></li><li class=list-inline-item><a href=https://localstack.cloud/terms>Terms of Service</a></li><li class=list-inline-item><a href=https://localstack.cloud/#>Imprint</a></li></ul></div></div></div></div></footer><script src=https://localstack.cloud/js/bootstrap.min.51b4083a09e54138d5bbe9c42a5f5f71af6e60a417f276d5620cbde3b15eb1a07c9ea17a889bc58074adf9b19641039a77521d3131f039300d2fe29ffa532aa8.js integrity="sha512-UbQIOgnlQTjVu+nEKl9fca9uYKQX8nbVYgy947FesaB8nqF6iJvFgHSt+bGWQQOad1IdMTHwOTANL+Kf+lMqqA==" crossorigin=anonymous defer></script><script src=https://localstack.cloud/js/highlight.min.8cdbefd08ec63ef25f4b2510ae50c13b3d9ed43e25a15ddb55f14c33130e68cf8be3131ccf2d087c49f5f21fe88c2f0e2715a21f936047d0d0b85dc48cb864b9.js integrity="sha512-jNvv0I7GPvJfSyUQrlDBOz2e1D4loV3bVfFMMxMOaM+L4xMczy0IfEn18h/ojC8OJxWiH5NgR9DQuF3EjLhkuQ==" crossorigin=anonymous defer></script><script src=https://localstack.cloud/main.min.c667076fdc4df64bfcdde045586335c6f39e83b2890638c198f84cf7b06629acef2ef8536a38a1c5978689f003b2bd3918bc5b3400e1e62670dd1a558e29ccd9.js integrity="sha512-xmcHb9xN9kv83eBFWGM1xvOeg7KJBjjBmPhM97BmKazvLvhTajihxZeGifADsr05GLxbNADh5iZw3RpVjinM2Q==" crossorigin=anonymous defer></script><script src=https://localstack.cloud/index.min.b7c90b25fcf9450b672c2ce4506e3056c7808d872c8b86eb919cdd4e851f8c9ba5fed0a4bfecfa3e25ffafe774357862bdf2312d15ad89e18a45c1fce80cf4d0.js integrity="sha512-t8kLJfz5RQtnLCzkUG4wVseAjYcsi4brkZzdToUfjJul/tCkv+z6PiX/r+d0NXhivfIxLRWtieGKRcH86Az00A==" crossorigin=anonymous defer></script></body></html>